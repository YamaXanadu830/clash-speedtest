<template>
  <div id="app" class="flex flex-col h-screen bg-gray-900">
    <!-- È°∂ÈÉ®Áä∂ÊÄÅÊ†è -->
    <header class="bg-gray-800 border-b border-gray-700 px-4 py-3">
      <div class="flex items-center justify-between">
        <!-- Â∑¶‰æßÔºöLogoÂíåÊ†áÈ¢ò -->
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <span class="text-2xl">‚ö°</span>
            <h1 class="text-xl font-bold text-white">Clash SpeedTest</h1>
          </div>
          <span class="text-sm text-gray-400">v{{ systemInfo.version || '1.0.0' }}</span>
        </div>
        
        <!-- ‰∏≠Èó¥ÔºöÂÖ®Â±ÄÁä∂ÊÄÅ -->
        <div class="flex items-center space-x-6 text-sm">
          <div v-if="configInfo" class="flex items-center space-x-2">
            <span class="text-gray-400">ÈÖçÁΩÆ:</span>
            <span class="text-green-400">{{ configFileName }}</span>
            <span class="text-gray-500">({{ configInfo.proxyCount }} ËäÇÁÇπ)</span>
          </div>
          <div v-if="isRunning" class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span class="text-gray-300">{{ runningTask }}</span>
          </div>
        </div>
        
        <!-- Âè≥‰æßÔºöÂø´Êç∑Êìç‰Ωú -->
        <div class="flex items-center space-x-3">
          <button @click="toggleConfigPanel" class="text-gray-400 hover:text-white transition-colors" title="ÈÖçÁΩÆÈù¢Êùø (Ctrl+,)">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </button>
          <button @click="showHelp" class="text-gray-400 hover:text-white transition-colors" title="Â∏ÆÂä©">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- ‰∏ªÂ∑•‰ΩúÂå∫ -->
    <main class="flex-1 flex flex-col overflow-hidden">
      <!-- Áªü‰∏ÄÈÖçÁΩÆÈù¢ÊùøÔºàÂèØÊäòÂè†Ôºâ -->
      <Transition name="slide-down">
        <div v-if="showConfigPanel" class="bg-gray-800 border-b border-gray-700 p-4">
          <div class="max-w-7xl mx-auto">
            <ConfigPanel 
              :config-info="configInfo"
              @load-config="handleLoadConfig"
              @config-changed="handleConfigChanged"
            />
          </div>
        </div>
      </Transition>

      <!-- ÂäüËÉΩÊ†áÁ≠æÈ°µ -->
      <div class="bg-gray-800 border-b border-gray-700">
        <div class="flex items-center px-4">
          <nav class="flex space-x-1">
            <button
              v-for="tab in tabs"
              :key="tab.id"
              @click="activeTab = tab.id"
              :class="[
                'px-4 py-3 text-sm font-medium transition-all duration-200',
                'border-b-2 hover:text-white',
                activeTab === tab.id 
                  ? 'text-white border-primary-500' 
                  : 'text-gray-400 border-transparent hover:border-gray-600'
              ]"
            >
              <span class="flex items-center space-x-2">
                <span>{{ tab.icon }}</span>
                <span>{{ tab.name }}</span>
                <span v-if="tab.badge" class="ml-2 px-2 py-0.5 text-xs bg-red-600 text-white rounded-full">
                  {{ tab.badge }}
                </span>
              </span>
            </button>
          </nav>
          
          <!-- Ê†áÁ≠æÈ°µÂè≥‰æßÂø´Êç∑Êìç‰Ωú -->
          <div class="ml-auto flex items-center space-x-3">
            <button
              v-if="activeTab === 'speedtest' && configInfo"
              @click="quickTest"
              class="text-sm text-primary-400 hover:text-primary-300"
            >
              üöÄ Âø´ÈÄüÊµãËØï
            </button>
            <button
              v-if="activeTab === 'monitor' && configInfo"
              @click="quickMonitor"
              class="text-sm text-primary-400 hover:text-primary-300"
            >
              üì° Âø´ÈÄüÁõëÊéß
            </button>
          </div>
        </div>
      </div>

      <!-- Âä®ÊÄÅÂÜÖÂÆπÂå∫ -->
      <div class="flex-1 overflow-hidden">
        <!-- ÈÄüÂ∫¶ÊµãËØïÈ°µÈù¢ -->
        <keep-alive>
          <SpeedTestView 
            v-if="activeTab === 'speedtest'" 
            :config-info="configInfo"
            :is-running="isRunning"
            @start-test="handleStartTest"
            @stop-test="handleStopTest"
          />
        </keep-alive>
        
        <!-- ÁõëÊéßÈ°µÈù¢ -->
        <keep-alive>
          <MonitorView 
            v-if="activeTab === 'monitor'"
            :config-info="configInfo"
            :is-running="isRunning"
            @start-monitor="handleStartMonitor"
            @stop-monitor="handleStopTest"
          />
        </keep-alive>
        
        <!-- ÊâπÈáèÁÆ°ÁêÜÈ°µÈù¢ -->
        <keep-alive>
          <BatchManageView
            v-if="activeTab === 'batch'"
            :config-info="configInfo"
          />
        </keep-alive>
        
        <!-- Êï∞ÊçÆÂàÜÊûêÈ°µÈù¢ -->
        <keep-alive>
          <AnalysisView
            v-if="activeTab === 'analysis'"
            :config-info="configInfo"
          />
        </keep-alive>
        
        <!-- ËÆæÁΩÆÈ°µÈù¢ -->
        <keep-alive>
          <SettingsView 
            v-if="activeTab === 'settings'"
            :system-info="systemInfo"
            @config-changed="handleSettingsChanged"
          />
        </keep-alive>
      </div>
    </main>

    <!-- Â∫ïÈÉ®Áä∂ÊÄÅÊ†è -->
    <footer class="bg-gray-800 border-t border-gray-700 px-4 py-2">
      <div class="flex items-center justify-between text-xs text-gray-400">
        <div class="flex items-center space-x-4">
          <span>{{ currentTime }}</span>
          <span v-if="lastTestTime">‰∏äÊ¨°ÊµãËØï: {{ lastTestTime }}</span>
        </div>
        <div class="flex items-center space-x-4">
          <span v-if="cpuUsage">CPU: {{ cpuUsage }}%</span>
          <span v-if="memoryUsage">ÂÜÖÂ≠ò: {{ memoryUsage }}MB</span>
          <span>{{ systemInfo.platform || 'Wails' }}</span>
        </div>
      </div>
    </footer>
  </div>
</template>

<script>
import { ref, computed, onMounted, onUnmounted } from 'vue'
import ConfigPanel from './components/ConfigPanel.vue'
import SpeedTestView from './views/SpeedTestView.vue'
import MonitorView from './views/MonitorView.vue'
import BatchManageView from './views/BatchManageView.vue'
import AnalysisView from './views/AnalysisView.vue'
import SettingsView from './views/SettingsView.vue'
import { GetSystemInfo, LoadConfig, StartSpeedTest, StartMonitor, StopTest } from '../wailsjs/go/main/App'
import { EventsOn, EventsOff } from '../wailsjs/runtime/runtime'

export default {
  name: 'App',
  components: {
    ConfigPanel,
    SpeedTestView,
    MonitorView,
    BatchManageView,
    AnalysisView,
    SettingsView
  },
  setup() {
    // Á≥ªÁªü‰ø°ÊÅØ
    const systemInfo = ref({
      platform: '',
      version: '',
      buildTime: ''
    })
    
    // ÈÖçÁΩÆ‰ø°ÊÅØ
    const configInfo = ref(null)
    const configFileName = computed(() => {
      if (!configInfo.value?.configPath) return ''
      return configInfo.value.configPath.split('/').pop()
    })
    
    // ÁïåÈù¢Áä∂ÊÄÅ
    const showConfigPanel = ref(true)
    const activeTab = ref('speedtest')
    const isRunning = ref(false)
    const runningTask = ref('')
    
    // Êó∂Èó¥ÊòæÁ§∫
    const currentTime = ref('')
    const lastTestTime = ref('')
    
    // Á≥ªÁªüËµÑÊ∫ê
    const cpuUsage = ref(0)
    const memoryUsage = ref(0)
    
    // Ê†áÁ≠æÈ°µÈÖçÁΩÆ
    const tabs = ref([
      { id: 'speedtest', name: 'ÈÄüÂ∫¶ÊµãËØï', icon: 'üöÄ' },
      { id: 'monitor', name: 'Á®≥ÂÆöÁõëÊéß', icon: 'üì°' },
      { id: 'batch', name: 'ÊâπÈáèÁÆ°ÁêÜ', icon: 'üì¶', badge: null },
      { id: 'analysis', name: 'Êï∞ÊçÆÂàÜÊûê', icon: 'üìä' },
      { id: 'settings', name: 'ËÆæÁΩÆ', icon: '‚öôÔ∏è' }
    ])
    
    // ÂàáÊç¢ÈÖçÁΩÆÈù¢Êùø
    const toggleConfigPanel = () => {
      showConfigPanel.value = !showConfigPanel.value
    }
    
    // ÊòæÁ§∫Â∏ÆÂä©
    const showHelp = () => {
      console.log('ÊòæÁ§∫Â∏ÆÂä©')
    }
    
    // Â§ÑÁêÜÈÖçÁΩÆÂä†ËΩΩ
    const handleLoadConfig = async (configData) => {
      try {
        const config = await LoadConfig(
          configData.configPath, 
          configData.filterRegex || '.+', 
          configData.blockKeywords || ''
        )
        configInfo.value = config
        lastTestTime.value = new Date().toLocaleTimeString()
        
        // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
        localStorage.setItem('lastConfigPath', configData.configPath)
        localStorage.setItem('lastFilterRegex', configData.filterRegex || '.+')
        localStorage.setItem('lastBlockKeywords', configData.blockKeywords || '')
      } catch (error) {
        console.error('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•:', error)
        alert('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•: ' + error)
      }
    }
    
    // Â§ÑÁêÜÈÖçÁΩÆÂèòÊõ¥
    const handleConfigChanged = async (changes) => {
      if (!configInfo.value) return
      
      try {
        const config = await LoadConfig(
          configInfo.value.configPath,
          changes.filterRegex || '.+',
          changes.blockKeywords || ''
        )
        configInfo.value = config
      } catch (error) {
        console.error('Êõ¥Êñ∞ÈÖçÁΩÆÂ§±Ë¥•:', error)
      }
    }
    
    // Â§ÑÁêÜÂºÄÂßãÊµãËØï
    const handleStartTest = async (testConfig) => {
      try {
        await StartSpeedTest(testConfig)
        isRunning.value = true
        runningTask.value = 'ÈÄüÂ∫¶ÊµãËØï‰∏≠'
      } catch (error) {
        console.error('ÂêØÂä®ÊµãËØïÂ§±Ë¥•:', error)
        alert('ÂêØÂä®ÊµãËØïÂ§±Ë¥•: ' + error)
      }
    }
    
    // Â§ÑÁêÜÂÅúÊ≠¢ÊµãËØï
    const handleStopTest = async () => {
      try {
        await StopTest()
        isRunning.value = false
        runningTask.value = ''
        lastTestTime.value = new Date().toLocaleTimeString()
      } catch (error) {
        console.error('ÂÅúÊ≠¢Â§±Ë¥•:', error)
        alert('ÂÅúÊ≠¢Â§±Ë¥•: ' + error)
      }
    }
    
    // Â§ÑÁêÜÂºÄÂßãÁõëÊéß
    const handleStartMonitor = async (monitorConfig) => {
      try {
        await StartMonitor(monitorConfig)
        isRunning.value = true
        runningTask.value = 'Á®≥ÂÆöÊÄßÁõëÊéß‰∏≠'
      } catch (error) {
        console.error('ÂêØÂä®ÁõëÊéßÂ§±Ë¥•:', error)
        alert('ÂêØÂä®ÁõëÊéßÂ§±Ë¥•: ' + error)
      }
    }
    
    // Â§ÑÁêÜËÆæÁΩÆÂèòÊõ¥
    const handleSettingsChanged = (settings) => {
      console.log('ËÆæÁΩÆÂèòÊõ¥:', settings)
    }
    
    // Âø´ÈÄüÊµãËØï
    const quickTest = async () => {
      if (!configInfo.value) return
      
      const defaultConfig = {
        configPath: configInfo.value.configPath,
        filterRegex: localStorage.getItem('lastFilterRegex') || '.+',
        blockRegex: localStorage.getItem('lastBlockKeywords') || '',
        serverURL: 'https://speed.cloudflare.com',
        downloadSize: 50 * 1024 * 1024,
        uploadSize: 20 * 1024 * 1024,
        timeout: 5,
        concurrent: 4,
        maxLatency: 800,
        minDownloadSpeed: 5,
        minUploadSpeed: 2,
        fastMode: false
      }
      
      await handleStartTest(defaultConfig)
    }
    
    // Âø´ÈÄüÁõëÊéß
    const quickMonitor = async () => {
      if (!configInfo.value) return
      
      const defaultConfig = {
        type: 'websocket',
        targetURL: 'wss://stream.binance.com:9443/ws/btcusdt@ticker',
        duration: 3600,
        interval: 1
      }
      
      await handleStartMonitor(defaultConfig)
    }
    
    // Êõ¥Êñ∞Êó∂Èó¥
    const updateTime = () => {
      currentTime.value = new Date().toLocaleTimeString()
    }
    
    // ËÆæÁΩÆÈîÆÁõòÂø´Êç∑ÈîÆ
    const setupKeyboardShortcuts = () => {
      const handleKeyPress = (event) => {
        // Ctrl+O - ÊâìÂºÄÈÖçÁΩÆÊñá‰ª∂
        if (event.ctrlKey && event.key === 'o') {
          event.preventDefault()
          showConfigPanel.value = true
        }
        // Ctrl+T - ÂºÄÂßã/ÂÅúÊ≠¢ÊµãËØï
        else if (event.ctrlKey && event.key === 't') {
          event.preventDefault()
          if (isRunning.value) {
            handleStopTest()
          } else if (activeTab.value === 'speedtest' && configInfo.value) {
            quickTest()
          }
        }
        // Ctrl+M - ÂºÄÂßã/ÂÅúÊ≠¢ÁõëÊéß
        else if (event.ctrlKey && event.key === 'm') {
          event.preventDefault()
          if (isRunning.value) {
            handleStopTest()
          } else if (activeTab.value === 'monitor' && configInfo.value) {
            quickMonitor()
          }
        }
        // Ctrl+, - ÊâìÂºÄËÆæÁΩÆ
        else if (event.ctrlKey && event.key === ',') {
          event.preventDefault()
          toggleConfigPanel()
        }
        // F5 - Âà∑Êñ∞ÈÖçÁΩÆ
        else if (event.key === 'F5') {
          event.preventDefault()
          if (configInfo.value) {
            handleLoadConfig({
              configPath: configInfo.value.configPath,
              filterRegex: configInfo.value.filter || '.+',
              blockKeywords: configInfo.value.block || ''
            })
          }
        }
        // ESC - ÂÅúÊ≠¢ÂΩìÂâçÊìç‰Ωú
        else if (event.key === 'Escape' && isRunning.value) {
          handleStopTest()
        }
      }
      
      document.addEventListener('keydown', handleKeyPress)
      return () => document.removeEventListener('keydown', handleKeyPress)
    }
    
    // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨
    const setupEventListeners = () => {
      const eventHandlers = {
        'test-start': () => {
          isRunning.value = true
          runningTask.value = 'ÈÄüÂ∫¶ÊµãËØï‰∏≠'
        },
        'test-complete': () => {
          isRunning.value = false
          runningTask.value = ''
          lastTestTime.value = new Date().toLocaleTimeString()
        },
        'test-error': () => {
          isRunning.value = false
          runningTask.value = ''
        },
        'test-stopped': () => {
          isRunning.value = false
          runningTask.value = ''
        },
        'monitor-start': () => {
          isRunning.value = true
          runningTask.value = 'Á®≥ÂÆöÊÄßÁõëÊéß‰∏≠'
        },
        'monitor-complete': () => {
          isRunning.value = false
          runningTask.value = ''
          lastTestTime.value = new Date().toLocaleTimeString()
        },
        'monitor-error': () => {
          isRunning.value = false
          runningTask.value = ''
        }
      }
      
      // Ê≥®ÂÜåÊâÄÊúâ‰∫ã‰ª∂ÁõëÂê¨Âô®
      Object.entries(eventHandlers).forEach(([eventName, handler]) => {
        EventsOn(eventName, handler)
      })
      
      return () => {
        Object.keys(eventHandlers).forEach(eventName => {
          EventsOff(eventName)
        })
      }
    }
    
    // ÂàùÂßãÂåñ
    onMounted(async () => {
      // Ëé∑ÂèñÁ≥ªÁªü‰ø°ÊÅØ
      try {
        systemInfo.value = await GetSystemInfo()
      } catch (error) {
        console.error('Ëé∑ÂèñÁ≥ªÁªü‰ø°ÊÅØÂ§±Ë¥•:', error)
      }
      
      // ÊÅ¢Â§ç‰∏äÊ¨°ÈÖçÁΩÆ
      const lastConfigPath = localStorage.getItem('lastConfigPath')
      if (lastConfigPath) {
        handleLoadConfig({
          configPath: lastConfigPath,
          filterRegex: localStorage.getItem('lastFilterRegex') || '.+',
          blockKeywords: localStorage.getItem('lastBlockKeywords') || ''
        })
      }
      
      // ÂêØÂä®Êó∂Èó¥Êõ¥Êñ∞
      updateTime()
      const timer = setInterval(updateTime, 1000)
      
      // ËÆæÁΩÆÈîÆÁõòÂø´Êç∑ÈîÆ
      const cleanupKeyboard = setupKeyboardShortcuts()
      
      // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨
      const cleanupEvents = setupEventListeners()
      
      onUnmounted(() => {
        clearInterval(timer)
        cleanupKeyboard()
        cleanupEvents()
      })
    })
    
    return {
      systemInfo,
      configInfo,
      configFileName,
      showConfigPanel,
      activeTab,
      isRunning,
      runningTask,
      currentTime,
      lastTestTime,
      cpuUsage,
      memoryUsage,
      tabs,
      toggleConfigPanel,
      showHelp,
      handleLoadConfig,
      handleConfigChanged,
      handleStartTest,
      handleStopTest,
      handleStartMonitor,
      handleSettingsChanged,
      quickTest,
      quickMonitor
    }
  }
}
</script>

<style>
/* ËøáÊ∏°Âä®Áîª */
.slide-down-enter-active,
.slide-down-leave-active {
  transition: all 0.3s ease;
}

.slide-down-enter-from {
  transform: translateY(-100%);
  opacity: 0;
}

.slide-down-leave-to {
  transform: translateY(-100%);
  opacity: 0;
}

/* Ëá™ÂÆö‰πâÊªöÂä®Êù° */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #1f2937;
}

::-webkit-scrollbar-thumb {
  background: #4b5563;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #6b7280;
}
</style>